# デプロイ・運用備忘録
むなかた子ども大学 公式サイト

最終更新: 2025-08-27

---

## 1. 本番環境概要

| 項目 | 設定値 |
|------|--------|
| 本番URL | https://munakata-kids-unv.jp |
| ホスティング | Vercel (Production環境) |
| ドメイン管理 | ムームードメイン |
| DNS管理 | ムームードメイン (External DNS) |
| SSL証明書 | Vercel自動管理 (Let's Encrypt) |

---

## 2. DNS管理方式の選択

### 2-1. 検討した選択肢

**1. External DNS使用 (ムームードメイン側でDNS設定) ← 採用**

**メリット:**
- DNS管理が慣れた場所（ムームードメイン）に残る
- 他のサブドメインやメール設定を既存のまま維持できる
- 移行時のリスクが低い（設定ミスがあっても元に戻しやすい）
- ドメイン管理とDNS管理が同じ場所で一元化

**デメリット:**
- DNS変更時にムームードメインとVercel両方の管理画面を確認する必要
- TTL設定によってはDNS変更の反映に時間がかかる場合がある
- ムームードメインのDNS機能に依存（サービス停止リスク）

**2. Vercel DNS (ネームサーバー変更)**

**メリット:**
- VercelダッシュボードだけでDNS管理が完結
- Vercelのエッジネットワークを最大限活用できる
- DNS応答速度がVercelに最適化される
- 設定変更の反映が早い

**デメリット:**
- **メール設定が複雑になる**（既存メールがある場合、MXレコード等の移行が必要）
- DNS管理がVercelに移るため、他のサービス連携時に設定場所が分散
- 移行時に設定ミスがあると全体に影響する可能性
- ムームードメインでのDNS設定履歴が見えなくなる

### 2-2. 採用決定

**採用方式: External DNS使用**
- メール機能や他のサブドメインへの影響を避けるため
- 管理の一元化と安全な移行を重視
- ムームードメインでの設定: `A @ 216.198.79.1`

---

## 3. ドメイン移行作業記録

### 2-1. 完了済み作業 ✅

**Vercel側準備 (2025-08-27完了)**
- [x] ドメイン追加: `munakata-kids-unv.jp`
- [x] Production環境に接続設定
- [x] DNS設定値取得: `A @ 216.198.79.1`
- [x] 環境変数設定確認
- [x] vercel.json設定確認
- [x] SSL証明書自動設定確認

**現在のステータス:**
- Vercel: munakata-kids-unv.jp (赤「!」Invalid Configuration) ← 正常状態
- Vercel: mku-site.vercel.app (青「✓」Valid Configuration)

### 2-2. 待機中作業 ⏳

**ムームードメイン移管**
- [ ] 前制作者からのドメイン移管譲渡完了
- [ ] クライアント名義でのムームードメインアカウント作成
- [ ] ドメイン管理権限の移行確認

### 2-3. 移行実施作業 📋

**DNS設定変更 (移管完了後実施)**
1. ムームードメイン管理画面にログイン
2. DNS設定 > カスタム設定
3. 以下の値を設定:
   ```
   種別: A
   サブドメイン: (空欄または@)
   内容: 216.198.79.1
   
   種別: A  
   サブドメイン: www
   内容: 216.198.79.1
   ```
4. 設定保存
5. DNS伝播待ち (5分〜数時間)

**動作確認**
- [ ] https://munakata-kids-unv.jp へのアクセス確認
- [ ] https://www.munakata-kids-unv.jp のリダイレクト確認
- [ ] SSL証明書の自動発行確認
- [ ] Vercelドメインステータス: 赤「!」→ 青「✓」変化確認
- [ ] 全ページの表示確認
- [ ] お問い合わせフォーム動作確認

---

## 3. 環境変数設定

**Vercel Production環境**
```env
MICROCMS_SERVICE_DOMAIN=mku2025
MICROCMS_API_KEY=zd2xVmqyffQvYvNQ2gkILFIlKEZMfWcojqov
NODE_ENV=production
```

---

## 4. 緊急時対応

### 4-1. ロールバック手順

**問題発生時の切り戻し:**
1. ムームードメインのDNS設定を元の値に戻す
2. 前制作者のhetemlサーバーに戻る
3. DNS伝播を待つ

**元の設定値 (要事前確認):**
- 前制作者から取得したDNS設定値をここに記録

### 4-2. 連絡先

| 役割 | 連絡先 | 備考 |
|------|--------|------|
| 前制作者 | (要記録) | ドメイン移管・旧サーバー管理 |
| クライアント | (要記録) | 最終承認・決定権者 |
| ムームードメイン | サポートページ | ドメイン移管・DNS設定 |
| Vercel | サポートページ | ホスティング・SSL証明書 |

---

## 5. 移行後の運用

### 5-1. 定期確認項目

**月次確認**
- [ ] SSL証明書の自動更新状況
- [ ] Vercel使用量確認
- [ ] ドメイン有効期限確認

**随時確認**
- [ ] サイト表示速度
- [ ] お問い合わせフォーム動作
- [ ] microCMS連携状況

### 5-2. 更新作業

**コンテンツ更新:**
- microCMS管理画面での更新
- Vercel自動デプロイ (mainブランチpush時)

**機能追加・修正:**
1. 開発環境での作業
2. Preview環境での確認
3. mainブランチへのマージ
4. Production自動デプロイ

---

## 6. 参考情報

**関連URL**
- Vercel Project: https://vercel.com/dashboard
- microCMS: https://mku2025.microcms.io/
- GitHub Repository: (要記録)

**設定ファイル**
- `vercel.json`: ルーティング・リダイレクト設定
- `CLAUDE.md`: 開発用プロンプト・技術仕様
- `package.json`: 依存関係・スクリプト