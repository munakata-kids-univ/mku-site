---
import BaseLayout from '@/layouts/BaseLayout.astro';
import HeroSection from '@/components/HeroSection.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';
import ContentSectionHeader from '@/components/ContentSectionHeader.astro';
import CourseCard from '@/components/CourseCard.astro';
import { 
  getGlobalSettings, 
  getSpecialCourses 
} from '../../../lib/microcms';
import { convertYearToPath } from '../../../utils/yearConverter';

// データ取得
const globalSettings = await getGlobalSettings();
const currentYear = globalSettings.currentYear;

// 現行年度の講座一覧を取得
const currentYearValue = Array.isArray(currentYear) ? currentYear[0] : currentYear;
if (!currentYearValue) {
  throw new Error('Current year is not defined');
}
const courses = await getSpecialCourses(currentYearValue.toString());

// 過去の実績セクション用：全年度の講座データを取得
const allCourses = await getSpecialCourses();

// ページ情報
const pageTitle = `特設講座（${currentYearValue}）`;
const pageDescription = `${currentYearValue}の特設講座一覧。月に1〜2回開催される職業体験講座で、より現実に即した環境での学びを提供します。`;

// パンくずリスト
const breadcrumbItems = [
  { label: 'ホーム', href: '/' },
  { label: '講座', href: '/course' },
  { label: '特設講座' }
];

// 申込ボタン（特設講座設定から取得、後で実装）
const buttons = [];

// currentYearと一致する講座のみをフィルタリング
const filteredCourses = courses.filter(course => {
  const courseYearValue = Array.isArray(course.year) ? course.year[0] : course.year;
  return courseYearValue === currentYearValue;
});

// 講座カード用のデータ変換
const currentYearPath = convertYearToPath(currentYearValue.toString());
const courseCards = filteredCourses.map(course => ({
  id: course.id,
  title: course.title,
  thumbImg: course.thumbImg,
  status: course.status,
  year: course.year,
  executedDate: course.executedDate,
  href: `/course/special-course/${currentYearPath}/${course.id}`,
  providerNames: course.providerItem?.map(item => item.providerName).join('、') || '',
  targetGrades: Array.isArray(course.targetGrades) ? course.targetGrades : (course.targetGrades ? [course.targetGrades] : []),
  hasReport: !!(course.afterImages?.length || course.instructor || course.afterReport || course.afterMovieUrl)
}));


// フェーズに応じたメッセージ（後で実装）
const getPhaseMessage = (phase: string) => {
  switch (phase) {
    case 'before':
      return '講座の申し込み受付を開始しました。下記のボタンからお申し込みください。';
    case 'during':
      return '講座を開催中です。参加者の皆様は実施要項をご確認ください。';
    case 'after':
      return '今年度の講座は終了しました。来年度の開催をお楽しみに。';
    default:
      return '';
  }
};

// TODO: 特設講座のフェーズ取得（後で実装）
const phase = 'before';
const phaseMessage = '';


// ステータス別の背景色クラス取得関数
function getStatusColorClass(status: string): string {
  switch (status) {
    case '募集前':
    case '募集締切':
      return 'status-badge--dark-gray';
    case '募集受付中':
      return 'status-badge--brand-secondary';
    case '抽選作業中':
      return 'status-badge--brand-turquoise';
    case '当選者発表':
      return 'status-badge--brand-pink';
    default:
      return 'status-badge--dark-gray';
  }
}

// フェーズをステータス表示文字列に変換する関数
function convertPhaseToStatus(phase: string): string {
  switch (phase) {
    case '募集前':
      return '募集前';
    case '募集締切':
      return '募集締切';
    case '1次募集受付中':
      return '1次募集受付中';
    case '2次募集受付中':
      return '2次募集受付中';
    case '1次抽選作業中':
      return '1次抽選作業中';
    case '1次当選者発表':
      return '1次当選者発表';
    case '開催中':
      return '開催中';
    case '終了':
      return '終了';
    default:
      return '準備中';
  }
}

// 講座のステータスを取得する関数（個別ステータス優先、フォールバックでフェーズ設定）
function getCourseStatus(course: any, globalPhase: string, currentYearValue: string): string {
  // 講座の年度を取得
  const courseYearValue = Array.isArray(course.year) ? course.year[0] : course.year;
  
  // 現在年度以外の講座（過去の実績）は強制的に「募集終了」
  if (courseYearValue !== currentYearValue) {
    return '募集終了';
  }
  
  // 現在年度の講座の場合、既存のロジックを適用
  // 個別の講座ステータスが設定されており、「フェーズ設定に従う」以外の場合はそれを使用
  if (course.status && Array.isArray(course.status) && course.status.length > 0 && 
      course.status[0] !== 'default' && course.status[0] !== 'フェーズ設定に従う') {
    return course.status[0];
  }
  
  // 個別ステータスが未設定、default、または「フェーズ設定に従う」の場合、グローバルフェーズを変換して使用
  const phaseValue = Array.isArray(globalPhase) ? globalPhase[0] : globalPhase;
  return convertPhaseToStatus(phaseValue || '準備中');
}

// 学年の色分けクラス取得関数（scheduleページと同様）
function getGradeColorClass(grade: string): string {
  // むなかた子ども大学の日（学校名）の場合
  if (grade.includes('小学校') || grade.includes('中学校') || grade.includes('学校') || grade.includes('学園')) {
    return 'mku-day';
  }
  
  // 特殊なケース
  if (grade === '未就学児' || grade === 'だれでも' || grade.includes('その他')) {
    return 'special';
  }
  
  // 数字を抽出
  const yearMatch = grade.match(/^(\d+)年$/);
  if (yearMatch) {
    const num = parseInt(yearMatch[1]);
    if (num >= 1 && num <= 3) return 'elementary-low';    // 1~3年
    if (num >= 4 && num <= 6) return 'elementary-high';   // 4~6年
    if (num >= 7 && num <= 9) return 'junior';            // 7~9年
  }
  
  // 高校生
  if (grade.match(/^高\d+$/)) {
    return 'junior'; // 高校生は中学生と同じ色
  }
  
  // その他
  return 'special';
}

// 日付フォーマット関数
function formatExecutedDate(dateString: string): string {
  if (!dateString) return '';
  
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  
  const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
  const weekday = weekdays[date.getDay()];
  
  return `${year}年${month}月${day}日(${weekday})`;
}

// 学年の整列順序関数（scheduleページと同様）
function formatTargetGrades(targetGrades: string | string[]): { sortedGrades: string[]; htmlString: string } {
  const grades = Array.isArray(targetGrades) ? targetGrades : [targetGrades];
  
  // 学年の表示順を決める関数
  function getGradeOrder(grade: string): number {
    // 未就学児は最初
    if (grade === '未就学児') {
      return 0;
    }
    
    // 1年～9年（小中学校）
    const elementaryJuniorMatch = grade.match(/^(\d+)年$/);
    if (elementaryJuniorMatch && elementaryJuniorMatch[1]) {
      const num = parseInt(elementaryJuniorMatch[1]);
      if (num >= 1 && num <= 9) {
        return num; // 1～9の順序
      }
    }
    
    // 高1～高3（高校）
    const highSchoolMatch = grade.match(/^高(\d+)$/);
    if (highSchoolMatch && highSchoolMatch[1]) {
      const num = parseInt(highSchoolMatch[1]);
      if (num >= 1 && num <= 3) {
        return 10 + num; // 11～13の順序（10 + 1～3）
      }
    }
    
    // その他は最後
    return 999;
  }
  
  // 学年を指定された順序でソート
  const sortedGrades = grades.sort((a, b) => {
    return getGradeOrder(a) - getGradeOrder(b);
  });
  
  return {
    sortedGrades,
    htmlString: sortedGrades.join('・') // 後方互換性のため
  };
}
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main>
    <!-- ヒーローセクション -->
    <HeroSection 
      title="特設講座"
      subtitle="Special Course"
      imageSrc="/images/backgrounds/img_bg-hero_special-course-01.webp"
      imageAlt="特設講座"
      customBackgroundStyle="hero--special-course"
    />

    <!-- パンくずリスト -->
    <Breadcrumb items={breadcrumbItems} />
  
    <!-- ①導入セクション -->
    <section class="intro-section">
      <div class="content-section__container intro-section__container">
        <div class="intro-section__content">
          <h1 class="intro-section__title">
            <span class="intro-section__title-line">本物の体験を、<br class="u-br-sm">もっと多くの子どもたちへ</span>
          </h1>
          <p class="intro-section__description">
            月に1〜2回、職業に関わる講座を中心に展開しています。宗像市内だけでなく、企業の施設や大学の実習室など、より現実に即した環境での職業体験を多数開催。<br>
            未就学児や市外在住の児童も参加できる講座や、不登校児童生徒の社会的自立のきっかけとなるような講座も用意し、子どもたちが年間通じて様々な職業体験にチャレンジできる機会を提供。
          </p>
          
          <!-- 特設講座 3つのポイント -->
          <div class="intro-section__points">
            <h2 class="intro-section__points-title">
              特設講座 <span class="intro-section__points-number">3</span>つのポイント
            </h2>
            
            <div class="intro-section__points-grid">
              <!-- ポイント01 -->
              <div class="intro-section__point">
                <div class="intro-section__point-image">
                  <img src="/images/content/img_special-course-point-01.webp" alt="ポイント1" />
                </div>
                <div class="intro-section__point-content">
                  <div class="intro-section__point-number">
                    <span class="point-text">point</span><span class="point-number">01</span>
                  </div>
                  <h3 class="intro-section__point-title">高頻度で開講</h3>
                  <p class="intro-section__point-description">
                    月1回以上のペースで講座を実施し、キャリア教育の機会を年間とおして提供。
                  </p>
                </div>
              </div>
              
              <!-- ポイント02 -->
              <div class="intro-section__point">
                <div class="intro-section__point-image">
                  <img src="/images/content/img_special-course-point-02.webp" alt="ポイント2" />
                </div>
                <div class="intro-section__point-content">
                  <div class="intro-section__point-number">
                    <span class="point-text">point</span><span class="point-number">02</span>
                  </div>
                  <h3 class="intro-section__point-title">“本物”の施設でも開催</h3>
                  <p class="intro-section__point-description">
                    事業者の施設など、市外へ飛び出し、より職業をイメージできるようなリアルな体験ができることも。
                  </p>
                </div>
              </div>
              
              <!-- ポイント03 -->
              <div class="intro-section__point">
                <div class="intro-section__point-image">
                  <img src="/images/content/img_special-course-point-03.webp" alt="ポイント3" />
                </div>
                <div class="intro-section__point-content">
                  <div class="intro-section__point-number">
                    <span class="point-text">point</span><span class="point-number">03</span>
                  </div>
                  <h3 class="intro-section__point-title">幅広い参加対象</h3>
                  <p class="intro-section__point-description">
                    未就学児や不登校の子どもたちに向けた講座や、市外在住の子どもたちも申し込める講座も開催。
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Navigation Links -->
          <div class="intro-section__page-nav">
            <nav class="page-nav__menu">
              <a href="#courses" class="page-nav__link">
                <div class="page-nav__arrow"></div>
                <span class="page-nav__text">開講コース案内</span>
              </a>
              <a href="#process" class="page-nav__link">
                <div class="page-nav__arrow"></div>
                <span class="page-nav__text">参加までの流れ</span>
              </a>
              <a href="#archive" class="page-nav__link">
                <div class="page-nav__arrow"></div>
                <span class="page-nav__text">過去の実績</span>
              </a>
            </nav>
          </div>
        </div>
      </div>
    </section>

    <!-- ②{currentYear}年度 開講コース -->
    <section id="courses" class="courses-section content-section">
      <div class="content-section__container">
        <!-- 申込ボタン Section -->
        {buttons.length > 0 && (
          <div class="application-buttons-section fade-up">
            <div class="application-buttons-check-label">＼Check／</div>
            <div class="application-buttons-grid">
              {buttons.map((button) => {
                // 外部リンクかどうかを判定
                const isExternalLink = button.url.startsWith('http://') || button.url.startsWith('https://');
                
                return (
                  <div class="application-button-item">
                    {button.labelAbove && (
                      <p class="application-button-item__label-above" set:html={button.labelAbove.replace(/\n/g, '<br>')}></p>
                    )}
                    <div class="application-button-item__button-wrapper">
                      <a 
                        href={button.url} 
                        class="application-button-item__button base-button base-button--blue"
                        target={isExternalLink ? '_blank' : undefined}
                        rel={isExternalLink ? 'noopener noreferrer' : undefined}
                      >
                        <span class="base-button__text" set:html={button.buttonText.replace(/\n/g, '<br>')}></span>
                        <div class="base-button__icon">
                          {isExternalLink ? (
                            <div class="base-button__icon-external">
                              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18.2609 18.2609H1.73913V1.73913H6.95652V0H0.869565C0.389351 0 0 0.389351 0 0.869565V19.1304C0 19.6106 0.389351 20 0.869565 20H19.1304C19.6106 20 20 19.6106 20 19.1304V13.0435H18.2609V18.2609Z" fill="currentColor"/>
                                <path d="M19.1304 0H11.3043V1.73913H17.0311L7.21118 11.559L8.44097 12.7888L18.2609 2.96892V8.69565H20V0.869565C20 0.389351 19.6106 0 19.1304 0Z" fill="currentColor"/>
                              </svg>
                            </div>
                          ) : (
                            <div class="base-button__icon-arrow"></div>
                          )}
                        </div>
                      </a>
                      {button.labelBelow && (
                        <p class="application-button-item__label-below" set:html={button.labelBelow.replace(/\n/g, '<br>')}></p>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <ContentSectionHeader 
          englishTitle=""
          title={`${currentYearValue} <br class="u-br-sm">開講コース`}
          customTitleWrapperStyle="courses-title-wrapper"
          customIconStyle="courses-icon"
          class="fade-up"
        />
        
        {courseCards.length > 0 ? (
          <div class="courses-grid">
            {courseCards.map(course => (
              <a href={course.href} class="course-card">
                <div class="course-card__image">
                  <img 
                    src={course.thumbImg?.url || '/images/ui/img_course-no-image-01.webp'} 
                    alt={course.title} 
                  />
                  {(() => {
                    const resolvedStatus = getCourseStatus(course, phase || '', currentYearValue);
                    return resolvedStatus && (
                      <div class="course-card__status">
                        <span class={`status-badge ${getStatusColorClass(resolvedStatus)}`}>{resolvedStatus}</span>
                      </div>
                    );
                  })()}
                  {course.hasReport && (
                    <div class="course-card__report-ribbon">
                      <div class="report-ribbon__tail"></div>
                      <div class="report-ribbon__circle">
                        <div class="report-ribbon__text">
                          <span class="report-ribbon__text-line1">実施</span><br>
                          <span class="report-ribbon__text-line2">レポート</span>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                <div class="course-card__content">
                  {course.executedDate && (
                    <p class="course-card__executed-date">{formatExecutedDate(course.executedDate)}</p>
                  )}
                  <div class="course-card__header">
                    <h3 class="course-card__title">{course.title}</h3>
                    <div class="course-card__arrow"></div>
                  </div>
                  {course.providerNames && (
                    <p class="course-card__provider">{course.providerNames}</p>
                  )}
                  {course.targetGrades.length > 0 && (
                    <div class="course-card__grades">
                      {(() => {
                        const { sortedGrades } = formatTargetGrades(course.targetGrades);
                        return sortedGrades.map(grade => (
                          <span class={`target-grade target-grade--${getGradeColorClass(grade)}`}>{grade}</span>
                        ));
                      })()}
                    </div>
                  )}
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <div class="empty-state__icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                <path d="M6 12v5c3 3 9 3 12 0v-5"/>
              </svg>
            </div>
            <p class="empty-state__description">
              現在、{currentYearValue}の講座は登録されていません。<br>
              講座が決まり次第、随時掲載いたしますので、<br class="u-br-sm">お待ちください。
            </p>
          </div>
        )}
      </div>
    </section>

    <!-- ③参加までの流れ -->
    <section id="process" class="process-section content-section">
      <div class="content-section__container">
        <ContentSectionHeader 
          englishTitle=""
          title="参加までの流れ"
          class="fade-up"
        />
        <div class="process-section__content">
          <div class="process-section__intro">
            <p>
              特設講座は申込・抽選があります。詳しくは以下の流れをご確認ください。
            </p>
          </div>
          <div class="process-section__illustration">
            <img 
              src="/images/content/img_special-course_joinflow-illustration-sp.webp" 
              alt="参加までの流れ"
              class="process-section__image process-section__image--sp"
            />
            <img 
              src="/images/content/img_special-course_joinflow-illustration-pc.webp" 
              alt="参加までの流れ"
              class="process-section__image process-section__image--pc"
            />
          </div>
          
          <!-- お問い合わせボタン -->
          <div class="process-section__contact-button">
            <a href="/contact" class="base-button base-button--blue">
              <span class="base-button__text">お問い合わせフォーム</span>
              <div class="base-button__icon">
                <div class="base-button__icon-arrow"></div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- ④過去の実績 -->
    <section id="archive" class="archive-section content-section">
      <div class="content-section__container archive-section__container">
        <ContentSectionHeader 
          englishTitle=""
          title="過去の実績"
          class="fade-up"
        />
        <div class="archive-section__content">
          <div class="archive-links">
            {(() => {
              // 全講座から年度を抽出し、重複を除去
              const allYears = allCourses.map(course => {
                const courseYear = Array.isArray(course.year) ? course.year[0] : course.year;
                return courseYear;
              }).filter((year, index, self) => self.indexOf(year) === index);
              
              // 現在年度の数字部分を取得（令和7年度 → 7）
              const currentYearNum = parseInt(currentYearValue.replace('令和', '').replace('年度', ''));
              
              // 現在年度より小さい年度のみフィルタリングし、数字の降順でソート
              const pastYears = allYears
                .filter(year => year && typeof year === 'string') // undefinedと非文字列をフィルタリング
                .map(year => {
                  const yearNum = parseInt(year.replace('令和', '').replace('年度', ''));
                  return { original: year, num: yearNum };
                })
                .filter(yearObj => yearObj.num < currentYearNum)
                .sort((a, b) => b.num - a.num) // 降順ソート
                .map(yearObj => yearObj.original);
              
              return pastYears.map(year => {
                if (!year) return null;
                const yearNum = parseInt(year.replace('令和', '').replace('年度', ''));
                const urlYear = `r${yearNum.toString().padStart(2, '0')}`;
                return (
                  <a href={`/course/special-course/${urlYear}`} class="base-button base-button--blue">
                    <span class="base-button__text">{year}</span>
                    <div class="base-button__icon">
                      <div class="base-button__icon-arrow"></div>
                    </div>
                  </a>
                );
              });
            })()}
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<style lang="scss">
@import "../../../styles/index";

/* 共通セクションスタイル */
.content-section {
  padding: 0 0 rem(120);
  background: $background-primary;
  position: relative;
  
  @include breakpoint-up(xl) {
    padding: 0 0 rem(160);
  }

  &__container {
    padding: 0 5%;
    overflow: hidden;
    @include breakpoint-up(xl) {
      padding: 0 rem(50);
    }
  }
}

/* セクション間の装飾要素 */
.section-decoration {
  border-top-left-radius: rem(30);
  border-bottom-right-radius: rem(30);
  
  @include breakpoint-up(md) {
    border-top-left-radius: rem(60);
    border-bottom-right-radius: rem(60);
  }
  
  @include breakpoint-up(lg) {
    border-top-left-radius: rem(72);
    border-bottom-right-radius: rem(72);
  }
  
  &::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
  }
}

/* ①導入セクション */
.intro-section {
  @extend .content-section;
  background: $background-primary;
  padding: rem(60) 0 rem(120);
  text-align: center;
  border-bottom-right-radius: rem(30);
  position: relative;
  
  @include breakpoint-up(md) {
    border-bottom-right-radius: rem(60);
  }
  
  @include breakpoint-up(lg) {
    border-bottom-right-radius: rem(72);
  }
  
  @include breakpoint-up(xl) {
    padding: rem(80) 0 rem(160);
  }
  
  &__container {
    position: relative;
    
    // 背景装飾SVG
    &::before {
      content: '';
      position: absolute;
      top: 0;
      right: rem(-200);
      width: rem(400);
      height: 100%;
      background-image: url('/images/content/img_line-decoration-turquoise-01.svg');
      background-repeat: no-repeat;
      background-position: top right;
      background-size: contain;
      opacity: 0.5;
      z-index: 0;
      pointer-events: none;
      
      @include breakpoint-up(md) {
        right: rem(-300);
        width: rem(600);
      }
      
      @include breakpoint-up(lg) {
        right: rem(-350);
        width: rem(700);
      }
    }
  }
  
  // 右下の切り欠け部分の背景色を設定（次のセクションと同色）
  &::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: rem(30);
    height: rem(30);
    background-color: $brand-sub-turquoise-low;
    z-index: -1;
    
    @include breakpoint-up(md) {
      width: rem(60);
      height: rem(60);
    }
    
    @include breakpoint-up(lg) {
      width: rem(72);
      height: rem(72);
    }
  }
  
  &__content {
    max-width: none;
    margin: 0;
    text-align: left;
    position: relative;
    z-index: 1;
  }
  
  &__title {
    @include font-ja-l(semibold);
    margin-bottom: rem(24);
    line-height: 1.4;
    
    @include breakpoint-up(lg) {
      @include font-ja-2l(semibold);
    }
  }
  
  &__title-line {
    font-size: rem(22);
    font-weight: 600;
    display: inline;
    background: linear-gradient(to bottom, transparent 15%, $brand-turquoise 15%, $brand-turquoise 93%, transparent 93%);
    color: $text-white;
    line-height: 1.6;
    padding: rem(4) rem(8) rem(2) rem(4);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
    
    @include breakpoint-up(md) {
      @include font-ja-l(semibold);
      padding: rem(4) rem(10) rem(2) rem(6);
    }
  }
  
  &__description {
    @include font-ja-s;
    color: $text-primary;
    line-height: 1.7;
    margin-bottom: rem(32);
    
    @include breakpoint-up(md) {
      margin-bottom: rem(48);
    }
    
    @include breakpoint-up(xl) {
      max-width: rem(1200);
    }
  }
  
  
  &__buttons {
    margin-top: rem(32);
  }
  
  // 特設講座 3つのポイント
  &__points {
    margin-top: rem(80);
    text-align: center;
    
    @include breakpoint-up(lg) {
      margin: rem(80) auto;
      max-width: rem(1140);
    }
  }
  
  &__points-title {
    @include font-ja-m(semibold);
    color: $text-primary;
    margin: 0 auto rem(30);
    text-align: center;
    border-left: 8px solid $brand-turquoise;
    border-right: 8px solid $brand-turquoise;
    display: inline-block;
    padding: 0 rem(20) rem(5);
    
    @include breakpoint-up(lg) {
      @include font-ja-l(semibold);
      margin: 0 auto rem(40);
    }
  }
  
  &__points-number {
    @include font-ja-l(semibold);
    color: $brand-turquoise;
    line-height: 1;
    vertical-align: baseline;
    position: relative;
    bottom: rem(-2);
    
    @include breakpoint-up(lg) {
      @include font-ja-2l(semibold);
      bottom: rem(-4);
    }
  }
  
  &__points-grid {
    display: flex;
    flex-direction: column;
    gap: rem(20);
    
    @include breakpoint-up(lg) {
      flex-direction: row;
      gap: rem(30);
    }
  }
  
  &__point {
    display: flex;
    gap: 0;
    align-items: flex-start;
    background: $background-secondary;
    border-radius: $radius-l;
    
    @include breakpoint-up(lg) {
      flex-direction: column;
      text-align: center;
      flex: 1;
      border-radius: $radius-2l;
    }
  }
  
  &__point-image {
    flex-shrink: 0;
    width: rem(130);
    height: rem(130);
    
    @include breakpoint-up(lg) {
      width: 100%;
      aspect-ratio: 4/3;
      height: auto;
      margin: 0 auto;
    }
    
    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: $radius-l;
      @include breakpoint-up(lg) {
        border-radius: $radius-2l;
      }
    }
  }
  
  &__point-content {
    flex: 1;
    padding: rem(6) rem(8) rem(6) rem(12);
    text-align: left;
    
    @include breakpoint-up(md) {
      padding: rem(10) rem(15) rem(10) rem(20);
    }
    
    @include breakpoint-up(lg) {
      flex: none;
      padding: rem(15) rem(20) rem(30);
      text-align: center;
    }
  }
  
  &__point-number {
    letter-spacing: 0.1em;
    margin-bottom: 0;
    color: $brand-turquoise;
    
    // Point部分
    .point-text {
      @include font-en-3s(semibold);
    }
    
    // 数字部分
    .point-number {
      @include font-en-s(semibold);
    }
  }
  
  &__point-title {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin-bottom: rem(12);
    
    @include breakpoint-up(lg) {
      @include font-ja-m(semibold);
    }
  }
  
  &__point-description {
    @include font-ja-2s;
    color: $text-primary;
    line-height: 1.6;
    margin: 0;
    
    @include breakpoint-up(lg) {
      @include font-ja-s;
      text-align: left;
    }
  }
  
  // ページナビゲーション
  &__page-nav {
    margin-top: rem(60);
    
    @include breakpoint-up(lg) {
      margin-top: rem(80);
    }
  }
}

/* ナビゲーションリンク */
.page-nav {
  &__menu {
    display: grid;
    width: 90%;
    margin: 0 auto;
    grid-template-columns: 1fr 1fr;
    gap: 0;

    @include breakpoint-up(sm) {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
    }
  }

  &__link {
    display: flex;
    align-items: center;
    gap: rem(5);
    color: $text-primary;
    text-decoration: none;
    transition: color 0.3s ease;
    padding: rem(6) rem(10);

    @include breakpoint-up(sm) {
      gap: rem(12);
      padding: rem(6) rem(20);
      border-right: 1px solid $border-secondary;
    }

    @include breakpoint-up(xl) {
      padding: rem(6) rem(30);
    }

    &:first-child {
      @include breakpoint-up(sm) {
        padding-left: 0;
      }
    }

    &:last-child {
      border-right: none;
    }

    &:hover {
      color: $brand-turquoise;
      text-decoration: none;

      .page-nav__arrow {
        transform: translateY(rem(6)) rotate(45deg);
      }
    }
  }

  &__text {
    @include font-ja-s(semibold);
  }

  &__arrow {
    width: rem(9);
    height: rem(9);
    border-right: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: rotate(45deg);
    transition: transform 0.3s ease;
    flex-shrink: 0;
    margin-right: rem(3);
  }
}

/* ②開講コースセクション */
.courses-section {
  @extend .section-decoration;
  background: $brand-sub-turquoise-low;
  
  &::after {
    background: linear-gradient(to bottom, $background-primary 50%, $background-primary 50%);
  }
}

/* 講座グリッド */
.courses-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: rem(12);
  padding-bottom: rem(32);
  
  @include breakpoint-up(md) {
    gap: rem(18);
    padding-bottom: rem(40);
  }
  
  @include breakpoint-up(lg) {
    grid-template-columns: repeat(3, 1fr);
  }
  @include breakpoint-up(xl) {
    max-width: rem(1400);
    margin: 0 auto;
    gap: rem(24);
    padding-bottom: rem(48);
  }
}

/* コースカード */
.course-card {
  background: $background-primary;
  border-radius: $radius-m;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  height: 100%;
  @include breakpoint-up(md) {
    border-radius: $radius-l;
  }
  
  &:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    text-decoration: none;
  }
  
  &__image {
    position: relative;
    aspect-ratio: 4 / 3;
    overflow: hidden;
    border-radius: $radius-m;

    @include breakpoint-up(md) {
      border-radius: $radius-l;
      aspect-ratio: 16 / 9;
    }
    
    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 5%, transparent 100%);
      pointer-events: none;
      z-index: 1;
    }
    
    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
  }
  
  &__status {
    position: absolute;
    top: rem(8);
    left: rem(8);
    z-index: 2;
    @include breakpoint-up(md) {
      top: rem(10);
      left: rem(10);
    }
    @include breakpoint-up(lg) {
      top: rem(12);
      left: rem(12);
    }
    
    img {
      height: rem(24);
      width: auto;
      
      @include breakpoint-up(md) {
        height: rem(32);
      }
    }
  }
  
  &__report-ribbon {
    position: absolute;
    bottom: rem(16);
    right: rem(8);
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    
    @include breakpoint-up(md) {
      bottom: rem(20);
      right: rem(10);
    }
    
    @include breakpoint-up(lg) {
      bottom: rem(24);
      right: rem(12);
    }
    
    @include breakpoint-up(xl) {
      bottom: rem(32);
    }
  }
  
  &__content {
    padding: rem(12) rem(12) rem(16);
    display: flex;
    flex-direction: column;
    flex: 1;
    
    @include breakpoint-up(md) {
      padding: rem(16) rem(16) rem(20);
    }
    
    @include breakpoint-up(lg) {
      padding: rem(20) rem(20) rem(30);
    }
  }
  
  &__executed-date {
    @include font-ja-3s(semibold);
    color: $text-dark-gray;
    margin: 0 0 rem(8) 0;
    line-height: 1.4;
    @include breakpoint-up(md) {
      @include font-ja-2s(semibold);
    }
    
    @include breakpoint-up(md) {
      margin-bottom: rem(10);
    }
    
    @include breakpoint-up(lg) {
      margin-bottom: rem(12);
    }
  }
  
  &__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: rem(8);
    margin-bottom: rem(12);
  }
  
  &__title {
    @include font-ja-2s(semibold);
    color: $text-primary;
    margin: 0;
    line-height: 1.4;
    flex: 1;
    
    @include breakpoint-up(md) {
      @include font-ja-s(semibold);
    }
    
    @include breakpoint-up(lg) {
      @include font-ja-m(semibold);
    }
  }
  
  &__arrow {
    width: rem(20);
    height: rem(20);
    background-color: $brand-turquoise;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s ease;
    
    @include breakpoint-up(md) {
      width: rem(24);
      height: rem(24);
    }
    
    &::after {
      content: '';
      width: rem(6);
      height: rem(6);
      border-right: 2px solid $text-white;
      border-bottom: 2px solid $text-white;
      transform: translateX(rem(-1)) rotate(-45deg);
      
      @include breakpoint-up(md) {
        width: rem(8);
        height: rem(8);
        transform: translateX(rem(-1)) rotate(-45deg);
      }
    }
  }
  
  &:hover &__arrow {
    transform: translateX(rem(2));
  }
  
  &:hover &__image img {
    transform: scale(1.1);
  }
  
  &__provider {
    @include font-ja-3s(semibold);
    color: $text-secondary;
    margin: 0 0 rem(12) 0;
    line-height: 1.4;
    flex-grow: 1;
    
    @include breakpoint-up(md) {
      @include font-ja-2s(semibold);
    }
  }
  
  &__grades {
    display: flex;
    flex-wrap: wrap;
    gap: rem(4);
    margin-top: auto;
    
    @include breakpoint-up(md) {
      gap: rem(6);
    }
  }
}

/* 実施レポートリボン */
.report-ribbon {
  &__tail {
    position: absolute;
    left: 50%;
    top: rem(30);
    transform: translateX(-50%);
    height: 0;
    width: 0;
    border-top: rem(12) solid $text-white;
    border-left: rem(12) solid $text-white;
    border-right: rem(12) solid $text-white;
    border-bottom: rem(12) solid transparent;
    border-radius: 0 0 rem(3) rem(3);
    z-index: 1;
    
    @include breakpoint-up(md) {
      top: rem(38);
    }
    @include breakpoint-up(lg) {
      top: rem(44);
    }
    @include breakpoint-up(xl) {
      top: rem(60);
      border-top: rem(18) solid $text-white;
      border-left: rem(18) solid $text-white;
      border-right: rem(18) solid $text-white;
      border-bottom: rem(18) solid transparent;
      border-radius: 0 0 rem(5) rem(5);
    }
  }
  
  &__circle {
    width: rem(40);
    height: rem(40);
    background-color: $brand-primary;
    border: 2px solid $text-white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 2;
    
    @include breakpoint-up(md) {
      width: rem(48);
      height: rem(48);
    }
    @include breakpoint-up(lg) {
      width: rem(52);
      height: rem(52);
    }
    @include breakpoint-up(xl) {
      width: rem(70);
      height: rem(70);
    }
  }
  
  &__text {
    color: $text-white;
    text-align: center;
    line-height: 0.6;
    padding-bottom: rem(4);
    @include breakpoint-up(md) {
      line-height: 0.7;
      padding-bottom: rem(4);
    }
    @include breakpoint-up(lg) {
      padding-bottom: 0;
    }
    @include breakpoint-up(xl) {
      line-height: 1;
      padding-bottom: rem(2);
    }
  }
  
  &__text-line1 {
    // 「実施」のスタイル
    @include font-ja-3s(semibold);
    
    @include breakpoint-up(lg) {
      @include font-ja-s(semibold);
      margin-top: rem(-1);
    }
  }
  
  &__text-line2 {
    // 「レポート」のスタイル
    @include font-ja-4s(semibold);
    margin-top: rem(-2);
    @include breakpoint-up(md) {
    }
    
    @include breakpoint-up(xl) {
      @include font-ja-3s(semibold);
      margin-top: 0;
    }
  }
}

/* ステータスバッジ */
.status-badge {
  @include font-ja-3s(semibold);
  color: $text-white;
  padding: rem(2) rem(4);
  border-radius: $radius-xs;
  white-space: nowrap;
  
  @include breakpoint-up(md) {
    @include font-ja-2s(semibold);
  }
  
  &--dark-gray {
    background: $background-dark-gray;
  }
  
  &--brand-secondary {
    background: $brand-secondary;
  }
  
  &--brand-turquoise {
    background: $brand-turquoise;
  }
  
  &--brand-pink {
    background: $brand-pink;
  }
}

/* 学年タグ（scheduleページと同じスタイル） */
.target-grade {
  @include font-ja-3s(semibold);
  padding: rem(2) rem(4);
  border: 1px solid $brand-black;
  border-radius: rem(8);
  white-space: nowrap;
  margin-bottom: rem(2);
  color: $text-primary;
  
  @include breakpoint-up(lg) {
    @include font-ja-2s(semibold);
    padding: rem(4) rem(6);
    border-radius: rem(10);
  }
  
  &--elementary-low {
    background-color: $brand-sub-yellow-low;
    color: $text-primary;
  }
  
  &--elementary-high {
    background-color: $brand-sub-purple-low;
    color: $text-primary;
  }
  
  &--junior {
    background-color: $brand-sub-turquoise-low;
    color: $text-primary;
  }
  
  &--special {
    background-color: $brand-sub-pink-low;
    color: $text-primary;
  }
  
  // むなかた子ども大学の日用（学校名表示）
  &--mku-day {
    background-color: $background-primary;
    border: 1px solid $brand-black;
    color: $text-primary;
  }
}

/* 空状態 */
.empty-state {
  text-align: center;
  padding: rem(40) 0 0;
  
  @include breakpoint-up(md) {
    // padding: rem(80;
  }
  
  &__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: rem(32);
    
    @include breakpoint-up(md) {
      margin-bottom: rem(40);
    }
    
    svg {
      width: rem(60);
      height: rem(60);
      color: $brand-primary;
      
      @include breakpoint-up(md) {
        width: rem(80);
        height: rem(80);
      }
    }
  }
  
  &__description {
    @include font-ja-s;
    color: $text-primary;
    line-height: 1.7;
    margin: 0;
  }
}

/* ③参加までの流れセクション */
.process-section {
  @extend .section-decoration;
  background: $background-primary;
  
  &::after {
    background: linear-gradient(to bottom, $brand-sub-turquoise-low 50%, $background-secondary 50%);
  }
  
  &__content {
    text-align: center;
  }
  
  &__intro {
    text-align: left;
    margin-bottom: rem(40);
    
    @include breakpoint-up(md) {
      margin-bottom: rem(48);
    }
    
    @include breakpoint-up(lg) {
      margin-bottom: rem(56);
    }
    
    p {
      @include font-ja-s;
      color: $text-primary;
      line-height: 1.7;
      margin: 0;
    }
  }
  
  &__contact-button {
    margin-top: rem(40);
    text-align: center;
    
    @include breakpoint-up(md) {
      margin-top: rem(48);
    }
    
    @include breakpoint-up(lg) {
      margin-top: rem(56);
    }
    
    .base-button {
      text-decoration: none;
      color: $text-white !important;
      
      &:hover {
        text-decoration: none;
        color: $text-white !important;
      }
      
      .base-button__text {
        color: $text-white !important;
      }
    }
  }
  
  &__illustration {
    max-width: rem(800);
    margin: 0 auto;
    
    @include breakpoint-up(md) {
      max-width: rem(1000);
    }
    
    @include breakpoint-up(lg) {
      max-width: rem(1200);
    }
  }
  
  &__image {
    width: 100%;
    height: auto;
    
    &--sp {
      display: block;
      
      @include breakpoint-up(sm) {
        display: none;
      }
    }
    
    &--pc {
      display: none;
      
      @include breakpoint-up(sm) {
        display: block;
      }
    }
  }
}

/* ④過去の実績セクション */
.archive-section {
  background: $background-secondary;
  border-top-left-radius: rem(30);
  position: relative;
  overflow: hidden;
  padding-bottom: 0;
  
  @include breakpoint-up(md) {
    border-top-left-radius: rem(60);
  }
  
  @include breakpoint-up(lg) {
    border-top-left-radius: rem(72);
  }
  
  &::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: $background-primary;
    z-index: -1;
  }
  
  &__container {
    position: relative;
    
    // 背景装飾SVG
    &::before {
      content: '';
      position: absolute;
      bottom: rem(-20);
      right: rem(-50);
      width: rem(200);
      height: rem(200);
      background-image: url('/logos/mark-del_mku_white.svg');
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      opacity: 0.5;
      z-index: 1;
      pointer-events: none;
      
      @include breakpoint-up(md) {
        right: rem(-60);
        width: rem(250);
        height: rem(250);
      }
      
      @include breakpoint-up(lg) {
        bottom: 0;
        right: rem(-40);
        width: rem(300);
        height: rem(300);
      }
    }
  }
  
  &__content {
    text-align: center;
    position: relative;
    z-index: 1;
    padding-bottom: rem(80);
    @include breakpoint-up(md) {
      padding-bottom: rem(100);
    }
    @include breakpoint-up(lg) {
      padding-bottom: rem(120);
    }
  }
}

/* アーカイブリンク */
.archive-links {
  display: flex;
  justify-content: center;
  gap: rem(16);
  flex-wrap: wrap;
  
  @include breakpoint-up(md) {
    gap: rem(24);
    justify-content: flex-start;
    margin: 0 auto;
  }
  
  .base-button {
    color: $text-white;
    text-decoration: none;
    
    &:hover {
      text-decoration: none;
      color: $text-primary;
    }
  }
}

/* 申込ボタンセクション */
.application-buttons-section {
  margin-top: rem(60);
  
  @include breakpoint-up(md) {
    margin-top: rem(80);
  }
  
  @include breakpoint-up(lg) {
    margin-top: rem(100);
  }
}

.application-buttons-check-label {
  @include font-ja-l(semibold);
  color: $brand-turquoise;
  text-align: center;
  margin-bottom: rem(10);
  animation: checkScale 2s ease-in-out infinite;
  
  @include breakpoint-up(lg) {
    @include font-ja-2l(semibold);
    margin-bottom: rem(10);
  }
}

.application-buttons-grid {
  display: flex;
  flex-direction: column;
  gap: rem(20);
  align-items: center;
  
  @include breakpoint-up(lg) {
    display: grid;
    gap: rem(24);
    max-width: rem(900);
    margin: 0 auto;
    justify-items: stretch;
    align-items: stretch;
    
    // 1つの場合：中央配置
    &:has(.application-button-item:only-child) {
      grid-template-columns: 1fr;
      justify-items: center;
      max-width: rem(500);
    }
    
    // 2つ以上の場合：2列グリッド
    &:not(:has(.application-button-item:only-child)) {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  @include breakpoint-up(xl) {
    max-width: rem(1000);
    
    &:has(.application-button-item:only-child) {
      max-width: rem(550);
    }
  }
}

.application-button-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  width: 100%;
  max-width: rem(420);
  padding: rem(28) rem(18);
  border: 2px solid $brand-turquoise;
  border-radius: $radius-m;
  background-color: $background-primary !important;
  background-image: 
    radial-gradient(circle, #c5f3fe 1px, transparent 1px),
    radial-gradient(circle, #c5f3fe 1px, transparent 1px) !important;
  background-position: 0 0, 6.5px 6.5px !important;
  background-size: 13px 13px !important;
  animation: buttonBoxScale 2.5s ease-in-out infinite;
  
  @include breakpoint-up(md) {
    padding: rem(36) rem(20) !important;
    border-radius: $radius-l;
    max-width: rem(480);
  }
  
  @include breakpoint-up(lg) {
    padding: rem(32) rem(30);
    
    // 複数ボタンの場合：max-widthなし（stretch）
    .application-buttons-grid:not(:has(.application-button-item:only-child)) & {
      max-width: none;
    }
    
    // 単体ボタンの場合：適切なmax-width維持
    .application-buttons-grid:has(.application-button-item:only-child) & {
      max-width: rem(480);
    }
  }
  
  @include breakpoint-up(xl) {
    padding: rem(40) rem(40) !important;
    
    // 複数ボタンの場合：max-widthなし（stretch）
    .application-buttons-grid:not(:has(.application-button-item:only-child)) & {
      max-width: none;
    }
    
    // 単体ボタンの場合：適切なmax-width維持
    .application-buttons-grid:has(.application-button-item:only-child) & {
      max-width: rem(520);
    }
  }
  
  &__label-above {
    @include font-ja-s(semibold);
    color: $text-secondary;
    margin: 0 0 rem(16) 0;
    text-align: left;
    line-height: 1.6;
    
    @include breakpoint-up(md) {
      margin-bottom: rem(20);
    }
  }
  
  &__button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
    justify-content: center;
    margin-top: rem(16);
    
    @include breakpoint-up(md) {
      margin-top: rem(20);
    }
  }
  
  &__button {
    color: $text-white !important;
    text-decoration: none !important;
    
    &:hover {
      color: $text-white !important;
      text-decoration: none !important;
    }
    
    &:focus {
      color: $text-white !important;
      text-decoration: none !important;
    }
    
    &:visited {
      color: $text-white !important;
      text-decoration: none !important;
    }
    
    .base-button__text {
      color: $text-white !important;
    }
  }
  
  &__label-below {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin: rem(5) 0 0 0;
    text-align: center;
    line-height: 1.6;
    
    @include breakpoint-up(md) {
      // margin-top: rem(20);
    }
  }
}

/* 外部リンクアイコン（SVG） */
:global(.base-button__icon-external) {
  width: rem(16);
  height: rem(16);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.5s ease;
  
  svg {
    width: 100%;
    height: 100%;
    transition: all 0.5s ease;
  }
}

// ブルーボタン用の外部リンクアイコン
:global(.base-button--blue .base-button__icon-external) {
  color: $brand-primary;
}

:global(.base-button--blue:hover .base-button__icon-external) {
  color: $brand-secondary;
  transform: rotate(360deg);
}

// ホワイトボタン用の外部リンクアイコン
:global(.base-button--white .base-button__icon-external) {
  color: $background-primary;
}

:global(.base-button--white:hover .base-button__icon-external) {
  color: $brand-secondary;
  transform: rotate(360deg);
}

// ピンクボタン用の外部リンクアイコン
:global(.base-button--pink .base-button__icon-external) {
  color: $brand-pink;
}

:global(.base-button--pink:hover .base-button__icon-external) {
  color: $brand-secondary;
  transform: rotate(360deg);
}

/* スケールアニメーション */
@keyframes checkScale {
  0%, 100% { 
    transform: scale(1); 
  }
  50% { 
    transform: scale(1.08); 
  }
}

@keyframes buttonBoxScale {
  0%, 100% { 
    transform: scale(1); 
  }
  40% { 
    transform: scale(1.02); 
  }
  60% { 
    transform: scale(1.02); 
  }
}

// courses-title-wrapperの全画面幅でpadding-leftを無効化
:global(.content-section__title-wrapper.courses-title-wrapper) {
  padding-left: 0 !important;
}
</style>

<script>
// 自動スクロール機能
document.addEventListener('DOMContentLoaded', function() {
  const navLinks = document.querySelectorAll('.page-nav__link');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      const href = this.getAttribute('href');
      const targetId = href?.substring(1);
      const targetElement = targetId ? document.getElementById(targetId) : null;
      
      if (targetElement) {
        const headerHeight = 80; // ヘッダーの高さ分のオフセット
        const elementPosition = targetElement.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerHeight;

        window.scrollTo({
          top: offsetPosition,
          behavior: 'smooth'
        });
      }
    });
  });
});
</script>