---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';
import { 
  getMainCampusCourseById,
  getMainCampusCourses,
  getGlobalSettings,
  getMainCampusSettings
} from '@/lib/microcms';
import { convertYearToPath, convertPathToYear } from '@/utils/yearConverter';
import { formatDateForCourse } from '@/utils/dateUtils';

// 静的パス生成
export async function getStaticPaths() {
  try {
    // 全ての講座データを取得（年度フィルターなしで全件取得）
    const allCourses = await getMainCampusCourses();
    
    if (!allCourses || allCourses.length === 0) {
      return [];
    }

    // 各講座のパスを生成
    const paths = allCourses.map(course => {
      const courseYear = Array.isArray(course.year) ? course.year[0] : course.year;
      const pathYear = convertYearToPath(courseYear);
      return {
        params: { 
          year: pathYear,
          id: course.id 
        },
        props: { course, originalYear: courseYear }
      };
    });

    return paths;
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

// パラメータを取得
const { year, id } = Astro.params;
const { course, originalYear } = Astro.props;

// パスから年度を復元
const actualYear = originalYear || convertPathToYear(year);

if (!year || !id) {
  return Astro.redirect('/404');
}

// グローバル設定とメインキャンパス設定を取得
const globalSettings = await getGlobalSettings();
const mainCampusSettings = await getMainCampusSettings();
const currentYear = Array.isArray(globalSettings.currentYear) ? globalSettings.currentYear[0] : globalSettings.currentYear;
const currentYearValue = currentYear; // currentYearValueとして定義
const phase = Array.isArray(mainCampusSettings.phase) ? mainCampusSettings.phase[0] : mainCampusSettings.phase;

// 講座データは既にpropsから取得済み
if (!course) {
  return Astro.redirect('/404');
}

// 講座の年度を確認
const courseYear = Array.isArray(course.year) ? course.year[0] : course.year;

// URLの年度と講座の年度が一致しない場合は404
if (courseYear !== actualYear) {
  return Astro.redirect('/404');
}

// 申込締切情報を取得（現在年度の講座のみ）
const deadlines = courseYear === currentYearValue 
  ? mainCampusSettings.deadlines || []
  : [];

// デバッグ情報
console.log('Debug info:');
console.log('courseYear:', courseYear);
console.log('currentYearValue:', currentYearValue);
console.log('mainCampusSettings.deadlines:', mainCampusSettings.deadlines);
console.log('deadlines assigned:', deadlines);

// 実施日情報を取得
const executedDates = mainCampusSettings.executedDate?.filter(item => {
  const itemYear = Array.isArray(item.year) ? item.year[0] : item.year;
  return itemYear === courseYear;
});

// 最初の実施日を表示用にフォーマット
const displayExecutedDate = executedDates && executedDates.length > 0 
  ? formatDateForCourse(executedDates[0].date) 
  : null;

// ページ情報
const pageTitle = `${course.title} | メインキャンパス`;
const pageDescription = course.shortDescription || `${course.title}の詳細情報です。`;

// パンくずリスト
const currentYearPath = convertYearToPath(currentYear);
const breadcrumbItems = [
  { label: 'ホーム', href: '/' },
  { label: '講座内容', href: '/course' },
  { label: 'メインキャンパス', href: '/course/main-campus' },
  { label: actualYear, href: '/course/main-campus' },
  { label: course.title, current: true }
];

// フェーズをステータス表示文字列に変換する関数
function convertPhaseToStatus(phase: string): string {
  switch (phase) {
    case '募集前':
      return '募集前';
    case '募集締切':
      return '募集締切';
    case '1次募集受付中':
      return '1次募集受付中';
    case '2次募集受付中':
      return '2次募集受付中';
    case '1次抽選作業中':
      return '1次抽選作業中';
    case '1次当選者発表':
      return '1次当選者発表';
    case '開催中':
      return '開催中';
    case '終了':
      return '終了';
    default:
      return '準備中';
  }
}

// 講座のステータスを取得する関数（個別ステータス優先、フォールバックでフェーズ設定）
function getCourseStatus(course: any, globalPhase: string, currentYearValue: string): string {
  // 講座の年度を取得
  const courseYearValue = Array.isArray(course.year) ? course.year[0] : course.year;
  
  // 現在年度以外の講座（過去の実績）は強制的に「募集終了」
  if (courseYearValue !== currentYearValue) {
    return '募集終了';
  }
  
  // 現在年度の講座の場合、既存のロジックを適用
  // 個別の講座ステータスが設定されており、「フェーズ設定に従う」以外の場合はそれを使用
  if (course.status && Array.isArray(course.status) && course.status.length > 0 && 
      course.status[0] !== 'default' && course.status[0] !== 'フェーズ設定に従う') {
    return course.status[0];
  }
  
  // 個別ステータスが未設定、default、または「フェーズ設定に従う」の場合、グローバルフェーズを変換して使用
  const phaseValue = Array.isArray(globalPhase) ? globalPhase[0] : globalPhase;
  return convertPhaseToStatus(phaseValue || '準備中');
}

// YouTubeまたはVimeoのURLから埋め込み用URLを生成する関数
function getEmbedUrl(url: string): string | null {
  if (!url) return null;
  
  // YouTube
  if (url.includes('youtube.com/watch?v=') || url.includes('youtu.be/')) {
    const videoId = url.includes('youtu.be/') 
      ? url.split('youtu.be/')[1].split('?')[0]
      : url.split('v=')[1].split('&')[0];
    return `https://www.youtube.com/embed/${videoId}`;
  }
  
  // Vimeo
  if (url.includes('vimeo.com/')) {
    const videoId = url.split('vimeo.com/')[1].split('?')[0];
    return `https://player.vimeo.com/video/${videoId}`;
  }
  
  return null;
}

// ステータス別の背景色クラス取得関数
function getStatusColorClass(status: string): string {
  switch (status) {
    case '募集前':
    case '募集締切':
    case '募集終了':
    case '準備中':
      return 'status-badge--dark-gray';
    case '1次募集受付中':
    case '2次募集受付中':
      return 'status-badge--brand-secondary';
    case '1次抽選作業中':
      return 'status-badge--brand-turquoise';
    case '1次当選者発表':
      return 'status-badge--brand-pink';
    case '開催中':
      return 'status-badge--brand-turquoise';
    case '終了':
      return 'status-badge--dark-gray';
    default:
      return 'status-badge--dark-gray';
  }
}

// 学年の色分けクラス取得関数
function getGradeColorClass(grade: string): string {
  // むなかた子ども大学の日（学校名）の場合
  if (grade.includes('小学校') || grade.includes('中学校') || grade.includes('学校') || grade.includes('学園')) {
    return 'mku-day';
  }
  
  // 特殊なケース
  if (grade === '未就学児' || grade === 'だれでも' || grade.includes('その他')) {
    return 'special';
  }
  
  // 数字を抽出
  const yearMatch = grade.match(/^(\d+)年$/);
  if (yearMatch && yearMatch[1]) {
    const num = parseInt(yearMatch[1]);
    if (num >= 1 && num <= 3) return 'elementary-low';    // 1~3年
    if (num >= 4 && num <= 6) return 'elementary-high';   // 4~6年
    if (num >= 7 && num <= 9) return 'junior';            // 7~9年
  }
  
  // 高校生
  if (grade.match(/^高\d+$/)) {
    return 'high-school'; // 高校生専用の色
  }
  
  // その他
  return 'special';
}

// 学年の整列順序関数（scheduleページと同様）
function formatTargetGrades(targetGrades: string | string[]): { sortedGrades: string[]; htmlString: string } {
  const grades = Array.isArray(targetGrades) ? targetGrades : [targetGrades];
  
  // 学年の表示順を決める関数
  function getGradeOrder(grade: string): number {
    // 未就学児は最初
    if (grade === '未就学児') {
      return 0;
    }
    
    // 1年～9年（小中学校）
    const elementaryJuniorMatch = grade.match(/^(\d+)年$/);
    if (elementaryJuniorMatch && elementaryJuniorMatch[1]) {
      const num = parseInt(elementaryJuniorMatch[1]);
      if (num >= 1 && num <= 9) {
        return num; // 1～9の順序
      }
    }
    
    // 高1～高3（高校）
    const highSchoolMatch = grade.match(/^高(\d+)$/);
    if (highSchoolMatch && highSchoolMatch[1]) {
      const num = parseInt(highSchoolMatch[1]);
      if (num >= 1 && num <= 3) {
        return 10 + num; // 11～13の順序（10 + 1～3）
      }
    }
    
    // その他は最後
    return 999;
  }
  
  // 学年を指定された順序でソート
  const sortedGrades = grades.sort((a, b) => {
    return getGradeOrder(a) - getGradeOrder(b);
  });
  
  return {
    sortedGrades,
    htmlString: sortedGrades.join('・') // 後方互換性のため
  };
}
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="course-detail">
    <!-- パンくずリスト -->
    <div class="course-detail__breadcrumb">
      <Breadcrumb items={breadcrumbItems} />
    </div>

    <!-- 講座情報セクション -->
    <section class="course-info-section">
      <div class="content-section__container">
        <div class="course-info">
          <div class="course-info__title-wrapper stripe">
            <div class="course-info__year">{actualYear}</div>
            <h1 class="course-info__title">{course.title}</h1>
          </div>
          
          {course.subtitle && (
            <div class="course-info__subtitle">{course.subtitle}</div>
          )}
          
          <div class="course-info__image">
            <img 
              src={course.thumbImg?.url || '/images/ui/img_course-no-image-01.webp'} 
              alt={course.title} 
            />
          </div>
          
          <!-- 実施レポートセクション -->
          {((course.afterImages && course.afterImages.length > 0) || course.instructor || course.afterReport || course.afterMovieUrl) && (
            <div class="course-info__after-report">
              <div class="after-report-content">
                <div class="after-report-inner">
                  <h2 class="course-info__after-report-title">実施レポート</h2>
                  {course.afterImages && course.afterImages.length > 0 && (
                    <div class="after-report-section">
                      <div class="after-report-images">
                        {course.afterImages.map((image, index) => (
                          <div key={index} class="after-report-image">
                            <img src={image.url} alt={`実施レポート画像 ${index + 1}`} />
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {course.instructor && (
                    <div class="after-report-section">
                      <h3 class="after-report-section-title">講師</h3>
                      <div class="after-report-instructor">
                        {course.instructor}
                      </div>
                    </div>
                  )}
                  
                  {course.afterReport && (
                    <div class="after-report-section">
                      <h3 class="after-report-section-title">参加者の感想</h3>
                      <div class="after-report-feedback rich-content" set:html={course.afterReport}></div>
                    </div>
                  )}
                  
                  {course.afterMovieUrl && (
                    <div class="after-report-section">
                      <h3 class="after-report-section-title">動画</h3>
                      <div class="after-report-movie">
                        {(() => {
                          const embedUrl = getEmbedUrl(course.afterMovieUrl);
                          return embedUrl ? (
                            <iframe
                              src={embedUrl}
                              frameborder="0"
                              allow="autoplay; encrypted-media"
                              allowfullscreen
                              class="video-embed"
                            ></iframe>
                          ) : (
                            <a href={course.afterMovieUrl} target="_blank" rel="noopener noreferrer">
                              {course.afterMovieUrl}
                            </a>
                          );
                        })()}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
          
          <!-- 詳細情報と講座内容の横並びレイアウト -->
          <div class="course-info__content-wrapper">
            <!-- 詳細情報セクション -->
            <div class="course-info__details">
              <div class="detail-item">
                <div class="detail-item__label">募集状況：</div>
                <div class="detail-item__value">
                  {(() => {
                    const resolvedStatus = getCourseStatus(course, phase || '', currentYearValue);
                    return (
                      <span class={`status-badge ${getStatusColorClass(resolvedStatus || '準備中')}`}>
                        {resolvedStatus || '準備中'}
                      </span>
                    );
                  })()}
                </div>
              </div>

              {/* 申込締切（現在年度のみ） */}
              {courseYear === currentYearValue && deadlines.length > 0 && (
                <div class="detail-item">
                  <div class="detail-item__label">申込締切：</div>
                  <div class="detail-item__value">
                    {deadlines.map((deadline, index) => (
                      <div key={index} class="deadline-item">
                        <span class="deadline-key">{deadline.deadlineKey}</span>
                        <span class="deadline-separator">　</span>
                        <span class="deadline-date">{formatDateForCourse(deadline.deadlineDate)}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* デバッグ用: 申込締切が表示されない場合の情報 */}
              {courseYear === currentYearValue && deadlines.length === 0 && (
                <div class="detail-item">
                  <div class="detail-item__label">申込締切：</div>
                  <div class="detail-item__value">
                    <span style="color: #999;">申込締切情報が設定されていません（デバッグ用表示）</span>
                  </div>
                </div>
              )}

              {/* 実施日 */}
              {displayExecutedDate && (
                <div class="detail-item">
                  <div class="detail-item__label">実施日：</div>
                  <div class="detail-item__value">
                    <span class="executed-date">{displayExecutedDate}</span>
                  </div>
                </div>
              )}
              
              {course.capacity && course.capacity > 0 && (
                <div class="detail-item">
                  <div class="detail-item__label">定員：</div>
                  <div class="detail-item__value">{course.capacity}</div>
                </div>
              )}
              
              {course.courseType && course.courseType.length > 0 && (
                <div class="detail-item">
                  <div class="detail-item__label">講座種別：</div>
                  <div class="detail-item__value">
                    {Array.isArray(course.courseType) ? course.courseType.join(', ') : course.courseType}
                  </div>
                </div>
              )}
              
              {course.providerInfo && course.providerInfo.length > 0 && (
                <div class="detail-item">
                  <div class="detail-item__label">
                    協力大学・<span class="u-br-sm-xl">企業・団体：</span>
                  </div>
                  <div class="detail-item__value">
                    {course.providerInfo.map((provider, index) => (
                      <div key={index} class="provider-item">
                        <div>{provider.providerName}</div>
                        {provider.providerUrl && (
                          <a href={provider.providerUrl} target="_blank" rel="noopener noreferrer" class="provider-link">
                            {provider.providerUrl}
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {course.targetGrades && course.targetGrades.length > 0 && (
                <div class="detail-item">
                  <div class="detail-item__label">対象：</div>
                  <div class="detail-item__value">
                    <div class="target-grades">
                      {(() => {
                        const { sortedGrades } = formatTargetGrades(course.targetGrades);
                        return sortedGrades.map((grade, index) => (
                          <span key={index} class={`target-grade target-grade--${getGradeColorClass(grade)}`}>{grade}</span>
                        ));
                      })()}
                    </div>
                  </div>
                </div>
              )}
              
              {course.venue && (
                course.venue.openingMeeting || course.venue.lecture || course.venue.closingMeeting
              ) && (
                <div class="detail-item">
                  <div class="detail-item__label">会場：</div>
                  <div class="detail-item__value">
                    <div class="venue-group">
                      {course.venue.openingMeeting && (
                        <div>はじめの会：{course.venue.openingMeeting}</div>
                      )}
                      {course.venue.lecture && (
                        <div>講座：{course.venue.lecture}</div>
                      )}
                      {course.venue.closingMeeting && (
                        <div>終わりの会：{course.venue.closingMeeting}</div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {course.remarks && (
                <div class="detail-item">
                  <div class="detail-item__label">特記事項：</div>
                  <div class="detail-item__value rich-content" set:html={course.remarks}></div>
                </div>
              )}
            </div>
            
            <!-- 講座内容セクション -->
            <div class="course-info__schedule">
              <h2 class="course-info__schedule-title">講座内容</h2>
              {course.periods && course.periods.length > 0 && (
                <div class="schedule-items">
                  {course.periods.map((period, index) => (
                    <div key={index} class="schedule-item">
                      <div class="schedule-item__period">
                        {(() => {
                          // "1限" → "1" + "限目"、"1・2限" → "1・2" + "限目" のように分割
                          const periodText = String(period.periodNo || ''); // 文字列に変換
                          if (periodText && typeof periodText === 'string') {
                            const match = periodText.match(/^(.+?)限$/);
                            if (match) {
                              const numberPart = match[1]; // "1" または "1・2"
                              return (
                                <>
                                  <span class="period-number">{numberPart}</span>
                                  <span class="period-suffix">限目</span>
                                </>
                              );
                            }
                          }
                          // フォールバック：マッチしない場合はそのまま表示
                          return `${periodText}目`;
                        })()}
                      </div>
                      <div class="schedule-item__desc rich-content" set:html={period.periodDesc}></div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
          
          <!-- 連絡事項セクション -->
          <div class="course-info__notices">
            <h2 class="course-info__schedule-title">連絡事項</h2>
            <div class="notices-content">
              <div class="notice-section">
                <h3 class="notice-section__title">メインキャンパス全体連絡事項</h3>
                <div class="notice-section__content rich-content">
                  {mainCampusSettings.globalNotice ? (
                    <div set:html={mainCampusSettings.globalNotice}></div>
                  ) : (
                    <p class="empty-notice">まだ連絡事項はありません。<br>開催日前日までにこまめに確認してください。</p>
                  )}
                </div>
              </div>
              <div class="notice-section">
                <h3 class="notice-section__title">本講座向け連絡</h3>
                <div class="notice-section__content rich-content">
                  {course.noticeCourse ? (
                    <div set:html={course.noticeCourse}></div>
                  ) : (
                    <p class="empty-notice">まだ連絡事項はありません。<br>開催日前日までにこまめに確認してください。</p>
                  )}
                </div>
              </div>
            </div>
          </div>
          
          <!-- 準備物セクション -->
          <div class="course-info__preparation">
            <h2 class="course-info__schedule-title">準備物</h2>
            <div class="preparation-content">
              <div class="rich-content">
                {course.preparation ? (
                  <div set:html={course.preparation}></div>
                ) : (
                  <p>まだ連絡事項はありません。<br>開催日前日までにこまめに確認してください。</p>
                )}
              </div>
            </div>
          </div>
          
          <!-- 受付・解散セクション -->
          <div class="course-info__reception">
            <h2 class="course-info__schedule-title">受付・解散</h2>
            <div class="reception-content">
              <div class="rich-content">
                {course.recpAndDism && typeof course.recpAndDism === 'string' ? (
                  <div set:html={course.recpAndDism}></div>
                ) : (
                  <p>まだ連絡事項はありません。<br>開催日前日までにこまめに確認してください。</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<style lang="scss">
@import '../../../../../styles/_index';

.course-detail {
  min-height: 100vh;
  background-color: $brand-sub-yellow-low;
  
  // ドット柄背景
  background-image: 
    radial-gradient(circle, $brand-secondary 1.5px, transparent 1.5px),
    radial-gradient(circle, $brand-secondary 1.5px, transparent 1.5px);
  background-position: 0 0, 6.5px 6.5px;
  background-size: 13px 13px;
}

.course-detail__breadcrumb {
  padding-top: rem(100); // ヘッダーと被らないよう調整
  background: transparent;
  
  @include breakpoint-up(lg) {
    padding-top: rem(120);
  }
  
  // パンくずリスト内の要素も透明背景にする
  :global(.breadcrumb) {
    background: transparent;
  }
  
  :global(.breadcrumb__list) {
    background: transparent;
  }
}

.course-info-section {
  padding: rem(40) 0 rem(80);
  
  @include breakpoint-up(lg) {
    padding: rem(60) 0 rem(120);
  }
  
  .content-section__container {
    padding: 0 5%;
    
    @include breakpoint-up(xl) {
      padding: 0 rem(50);
    }
  }
}

.course-info {
  background: $background-primary;
  border-radius: $radius-l;
  padding: rem(25) rem(15) rem(30);
  position: relative;
  overflow: visible;
  @include breakpoint-up(md) {
    padding: rem(25) rem(25) rem(30);
  }
  
  @include breakpoint-up(lg) {
    padding: rem(48);
    border-radius: $radius-2l;
  }
  @include breakpoint-up(xl) {
    max-width: rem(1260);
    margin: 0 auto;
  }
}

.course-info__title-wrapper {
  padding: rem(15);
  margin-bottom: rem(24);
  margin-left: calc(-1 * rem(15) - 2%);
  border-radius: rem(12);

  @include breakpoint-up(md) {
    padding: rem(15) rem(20);
    margin-left: calc(-1 * rem(25) - 2%);
  }
  
  @include breakpoint-up(lg) {
    padding: rem(24) rem(32);
    margin-bottom: rem(32);
    margin-left: calc(-1 * rem(48) - 2%);
    border-radius: rem(16);
  }
}

.stripe {
  background-image: repeating-linear-gradient(135deg, $brand-secondary, $brand-secondary 10px, $brand-sub-yellow 10px, $brand-sub-yellow 30px);
}

.course-info__year {
  @include font-ja-2s(semibold);
  color: $text-primary;
  margin-bottom: rem(3);
  
  @include breakpoint-up(sm) {
    @include font-ja-s(semibold);
  }
  
  @include breakpoint-up(lg) {
    @include font-ja-m(semibold);
    // margin-bottom: rem(12);
  }
}

.course-info__title {
  @include font-ja-m(semibold);
  color: $text-primary;
  margin: 0;
  
  @include breakpoint-up(sm) {
    @include font-ja-l(semibold);
  }
  
  @include breakpoint-up(lg) {
    @include font-ja-2l(semibold);
  }
}

.course-info__subtitle {
  @include font-ja-s(semibold);
  color: $text-primary;
  margin-bottom: rem(24);
  
  @include breakpoint-up(lg) {
    @include font-ja-m(semibold);
    margin-bottom: rem(32);
  }
}

.course-info__image {
  margin-bottom: rem(32);
  position: relative;
  
  @include breakpoint-up(lg) {
    margin-bottom: rem(48);
  }
  
  img {
    width: 100%;
    height: auto;
    aspect-ratio: 16/9;
    object-fit: cover;
    border-radius: $radius-m;
    @include breakpoint-up(lg) {
      border-radius: $radius-l;
    }
  }
  
  // 左上の装飾（objects）
  &::before {
    content: '';
    position: absolute;
    top: rem(-15);
    left: rem(-10);
    width: rem(120);
    height: rem(120);
    background-image: url('/images/ui/img_decoration-objects-yellow-01.svg');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: start;
    z-index: 10;
    
    @include breakpoint-up(md) {
      top: rem(-10);
      left: rem(-20);
      width: rem(160);
      height: rem(160);
    }
    
    @include breakpoint-up(lg) {
      top: rem(-10);
      left: rem(-20);
      width: 25%;
      height: rem(160);
    }
    
    @include breakpoint-up(xl) {
      top: rem(-10);
      left: rem(-20);
      width: 30%;
      height: rem(200);
    }
  }
  
  // 右下の装飾（dots）
  &::after {
    content: '';
    position: absolute;
    bottom: rem(-15);
    right: rem(-5);
    width: rem(160);
    height: rem(160);
    background-image: url('/images/ui/img_decoration-dots-yellow-01.svg');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: bottom;
    z-index: 10;
    
    @include breakpoint-up(md) {
      bottom: rem(-20);
      right: rem(-20);
      width: rem(200);
      height: rem(200);
    }
  }
}

.course-info__content-wrapper {
  display: flex;
  flex-direction: column;
  gap: rem(32);
  
  @include breakpoint-up(lg) {
    flex-direction: row;
    gap: rem(48);
  }
}

.course-info__details {
  flex: 1;
  padding-bottom: rem(20);

  @include breakpoint-up(sm) {
    padding-bottom: 0;
  }
}

.course-info__schedule {
  flex: 1;
}

.detail-item {
  display: flex;
  flex-direction: column;
  padding-top: rem(14);
  padding-bottom: rem(18);
  border-bottom: 1px solid $border-secondary;
  
  @include breakpoint-up(sm) {
    flex-direction: row;
    align-items: flex-start;
  }
  
  &:last-child {
    margin-bottom: 0;
  }
}

.detail-item__label {
  @include font-ja-2s;
  color: $text-secondary;
  margin-bottom: rem(4);
  min-width: rem(120);
  padding-left: rem(5);
  
  @include breakpoint-up(sm) {
    margin-bottom: 0;
    margin-right: rem(16);
    width: rem(120);
    flex-shrink: 0;
  }
}

.detail-item__value {
  @include font-ja-s(semibold);
  color: $text-primary;
  line-height: 1.6;
  flex: 1;
  padding-left: rem(15);
  padding-right: rem(15);

  @include breakpoint-up(sm) {
    padding-left: 0;
  }
  
}

// 申込締切の項目スタイリング
.deadline-item {
  display: flex;
  align-items: center;
  margin-bottom: rem(4);
  
  &:last-child {
    margin-bottom: 0;
  }
}

.deadline-key {
  @include font-ja-s(semibold);
  color: $text-primary;
  min-width: rem(100);
}

.deadline-separator {
  margin: 0 rem(4);
}

.deadline-date {
  @include font-ja-s(semibold);
  color: $text-primary;
}

// 実施日のスタイリング
.executed-date {
  @include font-ja-s(semibold);
  color: $text-primary;
}

// リッチエディタコンテンツのスタイル（microCMS用）
.detail-item__value.rich-content {
  // 基本テキストはregular
  @include font-ja-s;
  
  // コンテンツ幅制限
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  :global(h3), :global(h4), :global(h5) {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
    font-weight: 600 !important; // semiboldを明示的に指定
    font-size: inherit !important; // 統一されたフォントサイズを強制
  }
  
  :global(p) {
    @include font-ja-s; // regular
    color: $text-primary;
    margin: rem(8) 0;
    font-weight: 400 !important; // regularを明示的に指定
    
    &:first-child {
      margin-top: 0;
    }
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(strong), :global(b) {
    font-weight: 600 !important; // semibold
  }
  
  // どんな要素であっても最初の要素のmargin-topを0にする
  :global(*:first-child) {
    margin-top: 0 !important;
  }
  
  // 最後の要素のmargin-bottomも0にして整える
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    @include font-ja-s; // regular
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important; // regularを明示的に指定
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  // 埋込コンテンツ用のスタイル
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  // 画像用のスタイル（コンテンツ幅いっぱい、縦横比保持）
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  // リンク用のスタイル（協力大学・企業・団体のURLと同じ）
  :global(a) {
    @include font-ja-s(semibold);
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
}

.provider-item {
  margin-bottom: rem(8);
  
  &:last-child {
    margin-bottom: 0;
  }
}

.provider-link {
  @include font-ja-s(semibold);
  color: $text-link;
  text-decoration: underline;
  word-break: break-all;
  
  &:hover {
    color: $text-link-hover;
  }
}

.venue-group {
  margin-bottom: rem(8);
  
  &:last-child {
    margin-bottom: 0;
  }
  
  div {
    margin-bottom: rem(4);
    
    &:last-child {
      margin-bottom: 0;
    }
  }
}

.course-info__schedule-title {
  @include font-ja-m(semibold);
  color: $text-secondary;
  padding-bottom: rem(8);
  
  @include breakpoint-up(lg) {
    @include font-ja-l(semibold);
    padding-bottom: rem(16);
  }
}

.schedule-items {
  display: flex;
  flex-direction: column;
  gap: rem(16);
}

.schedule-item {
  padding: rem(16);
  border-radius: rem(8);
  border: 1px solid $border-secondary;

  @include breakpoint-up(md) {
    padding: rem(16) rem(16) rem(30);
  }
}

.schedule-item__period {
  margin-bottom: rem(8);
  background-color: $background-secondary;
  display: inline-block;
  padding: rem(10) rem(20) rem(10) rem(10);
  border-radius: 0 $radius-s $radius-s 0;
  margin-left: rem(-17);
  
  .period-number {
    @include font-ja-m(semibold);
    color: $brand-primary;
  }
  
  .period-suffix {
    @include font-ja-s(semibold);
    color: $text-primary;
  }
}

.schedule-item__desc {
  padding-left: rem(10);
}

// schedule-item__desc内のリッチコンテンツのスタイル
.schedule-item__desc.rich-content {
  // 基本テキストはregular
  @include font-ja-s;
  
  // コンテンツ幅制限
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  :global(h3), :global(h4), :global(h5) {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
    font-weight: 600 !important; // semiboldを明示的に指定
    font-size: inherit !important; // 統一されたフォントサイズを強制
  }
  
  :global(p) {
    @include font-ja-s; // regular
    color: $text-primary;
    margin: rem(8) 0;
    font-weight: 400 !important; // regularを明示的に指定
    
    &:first-child {
      margin-top: 0;
    }
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(strong), :global(b) {
    font-weight: 600 !important; // semibold
  }
  
  // 最初の要素のmargin-topを0にする
  :global(*:first-child) {
    margin-top: 0 !important;
  }
  
  // 最後の要素のmargin-bottomも0にして整える
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    @include font-ja-s; // regular
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important; // regularを明示的に指定
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  // 埋込コンテンツ用のスタイル
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  // 画像用のスタイル（コンテンツ幅いっぱい、縦横比保持）
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  // リンク用のスタイル（協力大学・企業・団体のURLと同じ）
  :global(a) {
    @include font-ja-s(semibold);
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
}

// ステータスバッジのスタイル（講座カードと同じ）
.status-badge {
  @include font-ja-3s(semibold);
  color: $text-white;
  padding: rem(2) rem(4);
  border-radius: $radius-xs;
  white-space: nowrap;
  display: inline-block;
  
  @include breakpoint-up(md) {
    @include font-ja-2s(semibold);
  }

  &--dark-gray {
    background: $background-dark-gray;
  }

  &--brand-secondary {
    background: $brand-secondary;
  }

  &--brand-turquoise {
    background: $brand-turquoise;
  }

  &--brand-pink {
    background: $brand-pink;
  }
}

// 学年タグのスタイル（scheduleページと同じ）
.target-grades {
  display: flex;
  flex-wrap: wrap;
  gap: rem(6);
}

.target-grade {
  @include font-ja-2s(semibold);
  padding: rem(4) rem(6);
  border: 1px solid $brand-black;
  border-radius: rem(10);
  white-space: nowrap;
  margin-bottom: rem(2);

  &--elementary-low {
    background-color: $brand-sub-yellow-low;
  }

  &--elementary-high {
    background-color: $brand-sub-purple-low;
  }

  &--junior {
    background-color: $brand-sub-turquoise-low;
  }

  &--high-school {
    background-color: #9db7d6;
  }

  &--special {
    background-color: $brand-sub-pink-low;
  }

  // むなかた子ども大学の日用（学校名表示）
  &--mku-day {
    background-color: $background-primary;
    border: 1px solid $brand-black;
  }
}

/* レスポンシブ改行ユーティリティ */
:global(.u-br-sm-xl) {
  display: inline;
  
  @include breakpoint-up(sm) {
    display: block;
  }
  
  @include breakpoint-up(xl) {
    display: inline;
  }
}

// 連絡事項セクション
.course-info__notices {
  margin-top: rem(32);
  
  @include breakpoint-up(lg) {
    margin-top: rem(48);
  }
}

.notices-content {
  padding: rem(16);
  background-color: #ffffff;
  background-image: linear-gradient(90deg, #cccccc80 1px, transparent 1px), linear-gradient(#cccccc80 1px, transparent 1px);
  background-position: 10px 10px;
  background-size: 31px 31px;
  border-radius: rem(8);
  border: 1px solid $border-secondary;
}

.notice-section {
  &:not(:last-child) {
    margin-bottom: rem(24);
  }
}

.notice-section__title {
  @include font-ja-s(semibold);
  color: $text-primary;
  margin-bottom: rem(8);
  background: linear-gradient(transparent 60%, $brand-sub-yellow 60%);
  padding: rem(2) 0;
  display: inline-block;
}

.notice-section__content {
  @include font-ja-s;
  color: $text-primary;
  line-height: 1.6;
}

// notices-content内のリッチコンテンツのスタイル（detail-item__value rich-contentと同様）
.notices-content .rich-content {
  // 基本テキストはregular
  @include font-ja-s;
  
  // コンテンツ幅制限
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  // 最初の要素のmargin-topを0にする
  :global(*:first-child) {
    margin-top: 0 !important;
  }
  
  :global(h3), :global(h4), :global(h5) {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
    font-weight: 600 !important; // semiboldを明示的に指定
    font-size: inherit !important; // 統一されたフォントサイズを強制
  }
  
  :global(p) {
    @include font-ja-s; // regular
    color: $text-primary;
    margin: rem(8) 0;
    font-weight: 400 !important; // regularを明示的に指定
    font-size: rem(16) !important; // ja-sサイズを明示的に指定
    
    &:last-child {
      margin-bottom: 0;
    }
  }
}

// notices-content内の各セクションのリッチコンテンツにも同様のスタイルを適用
.notices-content .notice-section .notice-section__content.rich-content {
  // 基本テキストはregular
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  :global(h3), :global(h4), :global(h5) {
    font-size: var(--font-size-ja-s) !important;
    font-weight: 600 !important;
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
  }
  
  :global(p) {
    font-size: var(--font-size-ja-s) !important;
    color: $text-primary !important;
    margin: rem(8) 0 !important;
    font-weight: 400 !important;
    line-height: 1.6 !important;
    
    &:last-child {
      margin-bottom: 0 !important;
    }
  }
  
  :global(strong), :global(b) {
    font-weight: 600 !important;
  }
  
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    font-size: var(--font-size-ja-s) !important;
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  :global(a) {
    font-size: var(--font-size-ja-s) !important;
    font-weight: 600 !important;
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
  
  // 最後の要素のmargin-bottomも0にして整える
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    @include font-ja-s; // regular
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important; // regularを明示的に指定
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  // 埋込コンテンツ用のスタイル
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  // 画像用のスタイル（コンテンツ幅いっぱい、縦横比保持）
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  // リンク用のスタイル（協力大学・企業・団体のURLと同じ）
  :global(a) {
    @include font-ja-s(semibold);
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
}

// 空の状態メッセージのスタイル
.notices-content .notice-section .notice-section__content.rich-content .empty-notice,
.preparation-content .rich-content .empty-notice,
.reception-content .rich-content .empty-notice {
  color: $text-primary !important;
  font-weight: 400 !important;
  margin: rem(8) 0 !important;
  font-size: var(--font-size-ja-s) !important; // ja-sサイズのCSS変数を直接使用
  line-height: 1.6 !important;
  
  &:first-child {
    margin-top: 0 !important;
  }
  
  &:last-child {
    margin-bottom: 0 !important;
  }
}

// 準備物セクション
.course-info__preparation {
  margin-top: rem(32);
  
  @include breakpoint-up(lg) {
    margin-top: rem(48);
  }
}

.preparation-content {
  padding: rem(16);
  background-color: #ffffff;
  background-image: linear-gradient(90deg, #cccccc80 1px, transparent 1px), linear-gradient(#cccccc80 1px, transparent 1px);
  background-position: 10px 10px;
  background-size: 31px 31px;
  border-radius: rem(8);
  border: 1px solid $border-secondary;
}

// preparation-content内のリッチコンテンツのスタイル
.preparation-content .rich-content {
  // 基本テキストはregular
  @include font-ja-s;
  
  // コンテンツ幅制限
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  // 最初の要素のmargin-topを0にする
  :global(*:first-child) {
    margin-top: 0 !important;
  }
  
  :global(h3), :global(h4), :global(h5) {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
    font-weight: 600 !important;
    font-size: inherit !important;
  }
  
  :global(p) {
    @include font-ja-s;
    color: $text-primary;
    margin: rem(8) 0;
    font-weight: 400 !important;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(strong), :global(b) {
    font-weight: 600 !important;
  }
  
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    @include font-ja-s;
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  :global(a) {
    @include font-ja-s(semibold);
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
}

// 受付・解散セクション
.course-info__reception {
  margin-top: rem(32);
  
  @include breakpoint-up(lg) {
    margin-top: rem(48);
  }
}

.reception-content {
  padding: rem(16);
  background-color: #ffffff;
  background-image: linear-gradient(90deg, #cccccc80 1px, transparent 1px), linear-gradient(#cccccc80 1px, transparent 1px);
  background-position: 10px 10px;
  background-size: 31px 31px;
  border-radius: rem(8);
  border: 1px solid $border-secondary;
}

// reception-content内のリッチコンテンツのスタイル
.reception-content .rich-content {
  // 基本テキストはregular
  @include font-ja-s;
  
  // コンテンツ幅制限
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  // 最初の要素のmargin-topを0にする
  :global(*:first-child) {
    margin-top: 0 !important;
  }
  
  :global(h3), :global(h4), :global(h5) {
    @include font-ja-s(semibold);
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
    font-weight: 600 !important;
    font-size: inherit !important;
  }
  
  :global(p) {
    @include font-ja-s;
    color: $text-primary;
    margin: rem(8) 0;
    font-weight: 400 !important;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(strong), :global(b) {
    font-weight: 600 !important;
  }
  
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    @include font-ja-s;
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  :global(a) {
    @include font-ja-s(semibold);
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
}

// 実施レポートセクション
.course-info__after-report {
  margin-bottom: rem(32);
  
  @include breakpoint-up(lg) {
    margin-bottom: rem(48);
  }
}

.course-info__after-report-title {
  @include font-ja-m(semibold);
  color: $text-primary;
  margin-bottom: rem(16);
  background: linear-gradient(transparent 60%, $brand-sub-yellow 60%);
  padding: rem(2) 0;
  display: inline-block;
  
  @include breakpoint-up(lg) {
    @include font-ja-l(semibold);
    margin-bottom: rem(24);
  }
}

.after-report-content {
  background-color: $brand-primary;
  border-radius: $radius-xs;
  padding: rem(6);
}

.after-report-inner {
  background-color: #ffffff;
  background-image: linear-gradient(90deg, #cccccc80 1px, transparent 1px), linear-gradient(#cccccc80 1px, transparent 1px);
  background-position: 10px 10px;
  background-size: 31px 31px;
  border-radius: $radius-m;
  padding: rem(16) rem(16) rem(30);

  @include breakpoint-up(md) {
    padding: rem(24) rem(24) rem(40);
  }

  @include breakpoint-up(lg) {
    padding: rem(30) rem(30) rem(50);
  }
  
  @include breakpoint-up(lg) {
    border-radius: $radius-l;
    padding: rem(40) rem(40) rem(60);
  }
}

.after-report-section {
  &:not(:last-child) {
    margin-bottom: rem(24);
    
    @include breakpoint-up(lg) {
      margin-bottom: rem(32);
    }
  }
}

.after-report-section-title {
  font-size: rem(16);
  font-weight: 600;
  color: $text-secondary;
  margin-bottom: rem(12);
  
  @include breakpoint-up(lg) {
    margin-bottom: rem(16);
    font-size: rem(20);
  }
}

.after-report-instructor {
  @include font-ja-s;
  color: $text-primary;
  line-height: 1.6;
}

.after-report-movie {
  a {
    @include font-ja-s(semibold);
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
  
  .video-embed {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: rem(8);
    border: none;
    
    @include breakpoint-up(lg) {
      border-radius: rem(12);
    }
  }
}

// afterImagesのレスポンシブレイアウト
.after-report-images {
  display: flex;
  flex-direction: column;
  gap: rem(16);
  
  @include breakpoint-up(sm) {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: rem(16);
  }
  
  @include breakpoint-up(lg) {
    gap: rem(24);
  }
}

.after-report-image {
  img {
    width: 100%;
    height: auto;
    aspect-ratio: 16/9;
    object-fit: cover;
    border-radius: rem(8);
    
    @include breakpoint-up(lg) {
      border-radius: rem(12);
    }
  }
}

// 参加者の感想のリッチエディタスタイル
.after-report-feedback.rich-content {
  // 基本テキストはregular
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
  
  :global(h3), :global(h4), :global(h5) {
    font-size: var(--font-size-ja-s) !important;
    font-weight: 600 !important;
    color: $text-primary;
    margin: rem(16) 0 rem(8) 0;
  }
  
  :global(p) {
    font-size: var(--font-size-ja-s) !important;
    color: $text-primary !important;
    margin: rem(8) 0 !important;
    font-weight: 400 !important;
    line-height: 1.6 !important;
    
    &:first-child {
      margin-top: 0 !important;
    }
    
    &:last-child {
      margin-bottom: 0 !important;
    }
  }
  
  :global(strong), :global(b) {
    font-weight: 600 !important;
  }
  
  :global(*:first-child) {
    margin-top: 0 !important;
  }
  
  :global(*:last-child) {
    margin-bottom: 0 !important;
  }
  
  :global(ul), :global(ol) {
    margin: rem(8) 0;
    padding-left: rem(20);
  }
  
  :global(ul) {
    list-style-type: disc;
  }
  
  :global(ol) {
    list-style-type: decimal;
  }
  
  :global(li) {
    font-size: var(--font-size-ja-s) !important;
    color: $text-primary;
    margin-bottom: rem(4);
    font-weight: 400 !important;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  :global(iframe) {
    max-width: 100%;
    height: auto;
    border: none;
    border-radius: rem(8);
  }
  
  :global(img) {
    width: 100% !important;
    height: auto !important;
    border-radius: rem(4);
    margin: rem(8) 0;
    display: block;
  }
  
  :global(figure) {
    display: block;
    margin: rem(8) 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    padding: 0;
    
    img {
      margin: 0;
      width: 100% !important;
      height: auto !important;
      display: block;
    }
  }
  
  :global(a) {
    font-size: var(--font-size-ja-s) !important;
    font-weight: 600 !important;
    color: $text-link;
    text-decoration: underline;
    word-break: break-all;
    
    &:hover {
      color: $text-link-hover;
    }
  }
}

// PDF プレビューブロック用のスタイル
:global(.pdf-canvas-block) {
  border: 1px solid $border-primary;
  border-radius: rem(8);
  margin: rem(16) 0;
  overflow: hidden;
  background: $background-primary;
  max-width: rem(1200);
}

:global(.pdf-canvas-header) {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: rem(12) rem(16);
  background: $background-secondary;
  border-bottom: 1px solid $border-primary;
  flex-wrap: wrap;
  gap: rem(8);
  
  @include breakpoint-up(md) {
    align-items: center;
    flex-wrap: nowrap;
    gap: rem(16);
    padding: rem(16) rem(20);
  }
  
  h4 {
    @include font-ja-2s(semibold);
    color: $text-primary;
    margin: 0;
    flex: 1;
    min-width: rem(200);
    word-break: break-word;
    
    @include breakpoint-up(md) {
      @include font-ja-s(semibold);
      min-width: auto;
    }
  }
  
  .pdf-controls {
    display: flex;
    gap: rem(4);
    align-items: center;
    flex-wrap: wrap;
    justify-content: flex-end;
    
    @include breakpoint-up(md) {
      gap: rem(8);
      flex-wrap: nowrap;
    }
    
    button {
      @include font-ja-3s(semibold);
      color: $text-link;
      background: transparent;
      border: 1px solid $text-link;
      border-radius: rem(4);
      padding: rem(3) rem(6);
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      
      @include breakpoint-up(md) {
        @include font-ja-2s(semibold);
        padding: rem(4) rem(8);
      }
      
      &:hover {
        background: $text-link;
        color: $text-white;
      }
      
      &:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    }
    
    a {
      @include font-ja-3s(semibold);
      color: $text-link;
      text-decoration: none;
      padding: rem(3) rem(6);
      border: 1px solid $text-link;
      border-radius: rem(4);
      transition: all 0.3s ease;
      white-space: nowrap;
      
      @include breakpoint-up(md) {
        @include font-ja-2s(semibold);
        padding: rem(4) rem(8);
      }
      
      &:hover {
        background: $text-link;
        color: $text-white;
      }
    }
    
    span {
      @include font-ja-3s;
      color: $text-secondary;
      white-space: nowrap;
      
      @include breakpoint-up(md) {
        @include font-ja-2s;
      }
    }
  }
}

:global(.pdf-canvas-container) {
  position: relative;
  background: $brand-black;
  padding: rem(8);
  text-align: center;
  height: rem(300);
  overflow-y: auto;
  overflow-x: hidden;
  
  @include breakpoint-up(md) {
    padding: rem(16);
    height: rem(400);
  }
  
  @include breakpoint-up(lg) {
    padding: rem(20);
    height: rem(450);
  }
  
  .pdf-pages-container {
    display: flex;
    flex-direction: column;
    gap: rem(8);
    align-items: center;
  }
  
  .pdf-page-canvas {
    max-width: 100%;
    height: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-radius: rem(4);
    display: block;
    margin: 0 auto;
    background: $text-white;
  }
  
  .pdf-loading {
    @include font-ja-2s;
    color: $text-secondary;
    padding: rem(20);
    
    @include breakpoint-up(md) {
      @include font-ja-s;
      padding: rem(40);
    }
  }
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// PDF Canvas表示機能
document.addEventListener('DOMContentLoaded', function() {
  console.log('PDF.js loaded:', typeof pdfjsLib !== 'undefined');
  
  // PDF.jsの設定
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // PDFリンクを自動的にプレビューに変換
    const pdfLinks = document.querySelectorAll('.rich-content a[data-mime-type="application/pdf"]');
    console.log('PDF links found:', pdfLinks.length);
    
    pdfLinks.forEach(link => {
      const pdfUrl = link.href;
      const fileName = link.textContent.trim();
      
      // PDFプレビューブロックを作成
      const pdfBlock = document.createElement('div');
      pdfBlock.className = 'pdf-canvas-block';
      pdfBlock.dataset.pdfUrl = pdfUrl;
      pdfBlock.innerHTML = `
        <div class="pdf-canvas-header">
          <h4>📄 ${fileName}</h4>
          <div class="pdf-controls">
            <a href="${pdfUrl}" target="_blank">PDFで開く</a>
          </div>
        </div>
        <div class="pdf-canvas-container">
          <div class="pdf-loading">PDFを読み込んでいます...</div>
          <div class="pdf-pages-container"></div>
        </div>
      `;
      
      // 元のリンクを置き換え
      link.parentNode.replaceChild(pdfBlock, link);
    });
    
    // PDF Canvas ブロックを処理
    const pdfCanvasBlocks = document.querySelectorAll('.pdf-canvas-block');
    
    pdfCanvasBlocks.forEach(block => {
      const url = block.dataset.pdfUrl;
      const pagesContainer = block.querySelector('.pdf-pages-container');
      const loadingDiv = block.querySelector('.pdf-loading');
      
      let pdfDoc = null;
      
      // PDFを読み込み
      pdfjsLib.getDocument(url).promise.then(pdf => {
        pdfDoc = pdf;
        const totalPages = pdf.numPages;
        
        // ローディング非表示
        if (loadingDiv) loadingDiv.style.display = 'none';
        
        // 全ページを順次描画
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
          renderPage(pageNum, pagesContainer);
        }
        
      }).catch(error => {
        console.error('PDF読み込みエラー:', error);
        if (loadingDiv) {
          loadingDiv.textContent = 'PDFの読み込みに失敗しました';
        }
      });
      
      // ページ描画関数
      function renderPage(pageNum, container) {
        pdfDoc.getPage(pageNum).then(page => {
          // 新しいキャンバスを作成
          const canvas = document.createElement('canvas');
          canvas.className = 'pdf-page-canvas';
          container.appendChild(canvas);
          
          // レスポンシブなスケール計算
          const containerWidth = block.querySelector('.pdf-canvas-container').clientWidth - 32; // padding分を引く
          
          // 基本スケールを設定
          let baseScale = 1.5;
          if (window.innerWidth < 768) {
            baseScale = 1.0; // モバイル
          } else if (window.innerWidth < 1024) {
            baseScale = 1.2; // タブレット
          }
          
          const viewport = page.getViewport({ scale: baseScale });
          
          // コンテナ幅に合わせてスケール調整
          let finalScale = baseScale;
          if (viewport.width > containerWidth) {
            finalScale = (containerWidth / viewport.width) * baseScale;
          }
          
          const finalViewport = page.getViewport({ scale: finalScale });
          
          // キャンバスサイズ設定
          canvas.width = finalViewport.width;
          canvas.height = finalViewport.height;
          
          // 高DPI対応
          const devicePixelRatio = window.devicePixelRatio || 1;
          if (devicePixelRatio > 1) {
            canvas.width = finalViewport.width * devicePixelRatio;
            canvas.height = finalViewport.height * devicePixelRatio;
            canvas.style.width = finalViewport.width + 'px';
            canvas.style.height = finalViewport.height + 'px';
            
            const ctx = canvas.getContext('2d');
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            page.render({
              canvasContext: ctx,
              viewport: finalViewport
            });
          } else {
            // 通常の描画
            const ctx = canvas.getContext('2d');
            page.render({
              canvasContext: ctx,
              viewport: finalViewport
            });
          }
        });
      }
      
      // ウィンドウリサイズ時の再描画
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (pdfDoc) {
            // 全ページを再描画
            pagesContainer.innerHTML = '';
            const totalPages = pdfDoc.numPages;
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
              renderPage(pageNum, pagesContainer);
            }
          }
        }, 300);
      });
    });
  }
});
</script>